<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP | Python 修炼手册</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="深入浅出的Python学习文档，从Python基础和高级编程到算法数据结构,Web开发，爬虫，大数据和人工智能">
    <link rel="preload" href="/python/assets/css/0.styles.055cc0b1.css" as="style"><link rel="preload" href="/python/assets/js/app.e1ee403d.js" as="script"><link rel="preload" href="/python/assets/js/2.968a03f5.js" as="script"><link rel="preload" href="/python/assets/js/46.e64c4e17.js" as="script"><link rel="prefetch" href="/python/assets/js/10.012951f0.js"><link rel="prefetch" href="/python/assets/js/11.94282480.js"><link rel="prefetch" href="/python/assets/js/12.44b4fd9e.js"><link rel="prefetch" href="/python/assets/js/13.a13f0565.js"><link rel="prefetch" href="/python/assets/js/14.d8e39cac.js"><link rel="prefetch" href="/python/assets/js/15.46786c41.js"><link rel="prefetch" href="/python/assets/js/16.b85eb3ee.js"><link rel="prefetch" href="/python/assets/js/17.96eaba02.js"><link rel="prefetch" href="/python/assets/js/18.a3db5906.js"><link rel="prefetch" href="/python/assets/js/19.588c0903.js"><link rel="prefetch" href="/python/assets/js/20.34ac6f63.js"><link rel="prefetch" href="/python/assets/js/21.4b026890.js"><link rel="prefetch" href="/python/assets/js/22.5508086b.js"><link rel="prefetch" href="/python/assets/js/23.7d5489f6.js"><link rel="prefetch" href="/python/assets/js/24.2885ce1a.js"><link rel="prefetch" href="/python/assets/js/25.c7bff1ee.js"><link rel="prefetch" href="/python/assets/js/26.f7ed45c0.js"><link rel="prefetch" href="/python/assets/js/27.999c5b6b.js"><link rel="prefetch" href="/python/assets/js/28.fac536a2.js"><link rel="prefetch" href="/python/assets/js/29.2edd588d.js"><link rel="prefetch" href="/python/assets/js/3.00a5d3f8.js"><link rel="prefetch" href="/python/assets/js/30.02da556d.js"><link rel="prefetch" href="/python/assets/js/31.8b2e3d98.js"><link rel="prefetch" href="/python/assets/js/32.b4efad96.js"><link rel="prefetch" href="/python/assets/js/33.85e23546.js"><link rel="prefetch" href="/python/assets/js/34.d1dec00c.js"><link rel="prefetch" href="/python/assets/js/35.b9ff4b4d.js"><link rel="prefetch" href="/python/assets/js/36.00458c5e.js"><link rel="prefetch" href="/python/assets/js/37.b5a94735.js"><link rel="prefetch" href="/python/assets/js/38.f228b7cb.js"><link rel="prefetch" href="/python/assets/js/39.4bd30457.js"><link rel="prefetch" href="/python/assets/js/4.ca72af8b.js"><link rel="prefetch" href="/python/assets/js/40.1d2da048.js"><link rel="prefetch" href="/python/assets/js/41.57a29faf.js"><link rel="prefetch" href="/python/assets/js/42.4f688b9c.js"><link rel="prefetch" href="/python/assets/js/43.914d9eb9.js"><link rel="prefetch" href="/python/assets/js/44.f0e4f09d.js"><link rel="prefetch" href="/python/assets/js/45.9e3d4438.js"><link rel="prefetch" href="/python/assets/js/47.74008a88.js"><link rel="prefetch" href="/python/assets/js/48.e81f8b9b.js"><link rel="prefetch" href="/python/assets/js/5.c4e0eacc.js"><link rel="prefetch" href="/python/assets/js/6.68364987.js"><link rel="prefetch" href="/python/assets/js/7.8ab3a63c.js"><link rel="prefetch" href="/python/assets/js/8.9add6df9.js"><link rel="prefetch" href="/python/assets/js/9.c501f952.js">
    <link rel="stylesheet" href="/python/assets/css/0.styles.055cc0b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/python/" class="home-link router-link-active"><!----> <span class="site-name">Python 修炼手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python/basic/intro.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.org/dotnet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  .Net Core
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/colin-chang/python" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python/basic/intro.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.org/dotnet" target="_blank" rel="noopener noreferrer" class="nav-link external">
  .Net Core
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.org/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/colin-chang/python" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/basic/intro.html" class="sidebar-link">Python简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/intro.html#_1-python介绍" class="sidebar-link">1. Python介绍</a></li><li class="sidebar-sub-header"><a href="/python/basic/intro.html#_2-python与ai" class="sidebar-link">2. Python与AI</a></li><li class="sidebar-sub-header"><a href="/python/basic/intro.html#_3-python应用场景" class="sidebar-link">3. Python应用场景</a></li><li class="sidebar-sub-header"><a href="/python/basic/intro.html#_4-python版本" class="sidebar-link">4. Python版本</a></li></ul></li><li><a href="/python/basic/ide.html" class="sidebar-link">Python执行方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/ide.html#_1-解释器执行" class="sidebar-link">1. 解释器执行</a></li><li class="sidebar-sub-header"><a href="/python/basic/ide.html#_2-交互式执行python" class="sidebar-link">2. 交互式执行Python</a></li><li class="sidebar-sub-header"><a href="/python/basic/ide.html#_3-python-ide" class="sidebar-link">3. Python IDE</a></li></ul></li><li><a href="/python/basic/standard.html" class="sidebar-link">代码规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/standard.html#_1-注释" class="sidebar-link">1. 注释</a></li><li class="sidebar-sub-header"><a href="/python/basic/standard.html#_2-中文支持" class="sidebar-link">2. 中文支持</a></li><li class="sidebar-sub-header"><a href="/python/basic/standard.html#_3-命名规则" class="sidebar-link">3. 命名规则</a></li><li class="sidebar-sub-header"><a href="/python/basic/standard.html#_4-代码规范" class="sidebar-link">4. 代码规范</a></li><li class="sidebar-sub-header"><a href="/python/basic/standard.html#_5-pass" class="sidebar-link">5. pass</a></li></ul></li><li><a href="/python/basic/io.html" class="sidebar-link">输入输出</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/io.html#_1-输入" class="sidebar-link">1. 输入</a></li><li class="sidebar-sub-header"><a href="/python/basic/io.html#_2-输出" class="sidebar-link">2. 输出</a></li><li class="sidebar-sub-header"><a href="/python/basic/io.html#_3-程序参数" class="sidebar-link">3. 程序参数</a></li></ul></li><li><a href="/python/basic/datatype.html" class="sidebar-link">数据类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/datatype.html#_1-数据类型" class="sidebar-link">1. 数据类型</a></li><li class="sidebar-sub-header"><a href="/python/basic/datatype.html#_2-数据类型转换" class="sidebar-link">2. 数据类型转换</a></li><li class="sidebar-sub-header"><a href="/python/basic/datatype.html#_3-对象引用" class="sidebar-link">3. 对象引用</a></li><li class="sidebar-sub-header"><a href="/python/basic/datatype.html#_4-可变类型-不可变类型" class="sidebar-link">4. 可变类型/不可变类型</a></li></ul></li><li><a href="/python/basic/operator.html" class="sidebar-link">运算符</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/operator.html#_1-算术运算符" class="sidebar-link">1. 算术运算符</a></li><li class="sidebar-sub-header"><a href="/python/basic/operator.html#_2-赋值运算符" class="sidebar-link">2. 赋值运算符</a></li><li class="sidebar-sub-header"><a href="/python/basic/operator.html#_3-比较运算符" class="sidebar-link">3. 比较运算符</a></li><li class="sidebar-sub-header"><a href="/python/basic/operator.html#_4-逻辑运算符" class="sidebar-link">4. 逻辑运算符</a></li><li class="sidebar-sub-header"><a href="/python/basic/operator.html#_5-位运算符" class="sidebar-link">5. 位运算符</a></li></ul></li><li><a href="/python/basic/processctrl.html" class="sidebar-link">流控制语句</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/processctrl.html#_1-条件语句" class="sidebar-link">1. 条件语句</a></li><li class="sidebar-sub-header"><a href="/python/basic/processctrl.html#_2-循环语句" class="sidebar-link">2. 循环语句</a></li></ul></li><li><a href="/python/basic/str.html" class="sidebar-link">字符串</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/str.html#_1-字符串基础" class="sidebar-link">1. 字符串基础</a></li><li class="sidebar-sub-header"><a href="/python/basic/str.html#_2-常用操作" class="sidebar-link">2. 常用操作</a></li><li class="sidebar-sub-header"><a href="/python/basic/str.html#_3-正则表达式" class="sidebar-link">3. 正则表达式</a></li></ul></li><li><a href="/python/basic/list.html" class="sidebar-link">列表 / 元组 / 集合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/list.html#_1-列表" class="sidebar-link">1. 列表</a></li><li class="sidebar-sub-header"><a href="/python/basic/list.html#_2-元组" class="sidebar-link">2. 元组</a></li><li class="sidebar-sub-header"><a href="/python/basic/list.html#_3-集合" class="sidebar-link">3. 集合</a></li></ul></li><li><a href="/python/basic/dict.html" class="sidebar-link">字典</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/dict.html#_1-字典简介" class="sidebar-link">1. 字典简介</a></li><li class="sidebar-sub-header"><a href="/python/basic/dict.html#_2-crud" class="sidebar-link">2. CRUD</a></li><li class="sidebar-sub-header"><a href="/python/basic/dict.html#_3-遍历" class="sidebar-link">3. 遍历</a></li></ul></li><li><a href="/python/basic/function.html" class="sidebar-link">函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/function.html#_1-声明调用" class="sidebar-link">1. 声明调用</a></li><li class="sidebar-sub-header"><a href="/python/basic/function.html#_2-函数参数" class="sidebar-link">2. 函数参数</a></li><li class="sidebar-sub-header"><a href="/python/basic/function.html#_3-作用域" class="sidebar-link">3. 作用域</a></li><li class="sidebar-sub-header"><a href="/python/basic/function.html#_4-lambda-匿名函数" class="sidebar-link">4. lambda 匿名函数</a></li><li class="sidebar-sub-header"><a href="/python/basic/function.html#_5-闭包" class="sidebar-link">5. 闭包</a></li><li class="sidebar-sub-header"><a href="/python/basic/function.html#_6-内建函数" class="sidebar-link">6. 内建函数</a></li></ul></li><li><a href="/python/basic/oo.html" class="sidebar-link">面向对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_1-类" class="sidebar-link">1. 类</a></li><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_2-类内建属性和方法" class="sidebar-link">2. 类内建属性和方法</a></li><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_3-property" class="sidebar-link">3. property</a></li><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_4-类级别成员" class="sidebar-link">4. 类级别成员</a></li><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_5-继承" class="sidebar-link">5. 继承</a></li><li class="sidebar-sub-header"><a href="/python/basic/oo.html#_6-多态" class="sidebar-link">6. 多态</a></li></ul></li><li><a href="/python/basic/module.html" class="sidebar-link">模块 / 包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/module.html#_1-模块简介" class="sidebar-link">1. 模块简介</a></li><li class="sidebar-sub-header"><a href="/python/basic/module.html#_2-导入模块" class="sidebar-link">2. 导入模块</a></li><li class="sidebar-sub-header"><a href="/python/basic/module.html#_3-模块高级" class="sidebar-link">3. 模块高级</a></li><li class="sidebar-sub-header"><a href="/python/basic/module.html#_4-包" class="sidebar-link">4. 包</a></li><li class="sidebar-sub-header"><a href="/python/basic/module.html#_5-标准库" class="sidebar-link">5. 标准库</a></li></ul></li><li><a href="/python/basic/accessibility.html" class="sidebar-link">可访问性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/accessibility.html#_1-可访问性" class="sidebar-link">1. 可访问性</a></li><li class="sidebar-sub-header"><a href="/python/basic/accessibility.html#_2-名字重整" class="sidebar-link">2. 名字重整</a></li></ul></li><li><a href="/python/basic/copy.html" class="sidebar-link">深拷贝与浅拷贝</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/copy.html#_1-深拷贝与浅拷贝" class="sidebar-link">1. 深拷贝与浅拷贝</a></li><li class="sidebar-sub-header"><a href="/python/basic/copy.html#_2-浅拷贝" class="sidebar-link">2. 浅拷贝</a></li><li class="sidebar-sub-header"><a href="/python/basic/copy.html#_3-深拷贝" class="sidebar-link">3. 深拷贝</a></li><li class="sidebar-sub-header"><a href="/python/basic/copy.html#_4-copy-copy" class="sidebar-link">4. copy.copy()</a></li></ul></li><li><a href="/python/basic/file.html" class="sidebar-link">文件操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/file.html#_1-文件读写" class="sidebar-link">1. 文件读写</a></li><li class="sidebar-sub-header"><a href="/python/basic/file.html#_2-文件-目录操作" class="sidebar-link">2. 文件 / 目录操作</a></li><li class="sidebar-sub-header"><a href="/python/basic/file.html#_3-路径操作" class="sidebar-link">3. 路径操作</a></li><li class="sidebar-sub-header"><a href="/python/basic/file.html#_4-案例" class="sidebar-link">4.案例</a></li></ul></li><li><a href="/python/basic/exception.html" class="sidebar-link">异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/exception.html#_1-异常基本处理" class="sidebar-link">1. 异常基本处理</a></li><li class="sidebar-sub-header"><a href="/python/basic/exception.html#_2-自定义异常" class="sidebar-link">2. 自定义异常</a></li></ul></li><li><a href="/python/basic/logging.html" class="sidebar-link">日志处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_1-logging-简单日志" class="sidebar-link">1. logging 简单日志</a></li><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_2-logging-组件" class="sidebar-link">2. logging 组件</a></li><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_3-日志处理" class="sidebar-link">3. 日志处理</a></li><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_4-日志配置" class="sidebar-link">4. 日志配置</a></li><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_5-记录上下文信息" class="sidebar-link">5. 记录上下文信息</a></li><li class="sidebar-sub-header"><a href="/python/basic/logging.html#_6-分布式日志" class="sidebar-link">6. 分布式日志</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python高级</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/senior/generator.html" class="sidebar-link">生成器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/generator.html#_1-生成器" class="sidebar-link">1. 生成器</a></li><li class="sidebar-sub-header"><a href="/python/senior/generator.html#_2-生成器推导式" class="sidebar-link">2. 生成器推导式</a></li><li class="sidebar-sub-header"><a href="/python/senior/generator.html#_3-yield" class="sidebar-link">3. yield</a></li><li class="sidebar-sub-header"><a href="/python/senior/generator.html#_4-send" class="sidebar-link">4. send</a></li></ul></li><li><a href="/python/senior/iterator.html" class="sidebar-link">迭代器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/iterator.html#_1-可迭代对象" class="sidebar-link">1. 可迭代对象</a></li><li class="sidebar-sub-header"><a href="/python/senior/iterator.html#_2-迭代器" class="sidebar-link">2. 迭代器</a></li></ul></li><li><a href="/python/senior/decorator.html" class="sidebar-link">装饰器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_1-装饰器" class="sidebar-link">1. 装饰器</a></li><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_2-多装饰器" class="sidebar-link">2. 多装饰器</a></li><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_3-参数与返回值" class="sidebar-link">3. 参数与返回值</a></li><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_4-有参装饰器" class="sidebar-link">4. 有参装饰器</a></li><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_5-类装饰器" class="sidebar-link">5. 类装饰器</a></li><li class="sidebar-sub-header"><a href="/python/senior/decorator.html#_6-wraps-装饰器" class="sidebar-link">6. wraps 装饰器</a></li></ul></li><li><a href="/python/senior/contextmanager.html" class="sidebar-link">上下文管理器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/contextmanager.html#_1-上下文管理器" class="sidebar-link">1. 上下文管理器</a></li><li class="sidebar-sub-header"><a href="/python/senior/contextmanager.html#_2-contextmanager" class="sidebar-link">2. contextmanager</a></li></ul></li><li><a href="/python/senior/dynamic.html" class="sidebar-link">动态扩展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/dynamic.html#_1-动态语言" class="sidebar-link">1. 动态语言</a></li><li class="sidebar-sub-header"><a href="/python/senior/dynamic.html#_2-动态扩展对象" class="sidebar-link">2. 动态扩展对象</a></li><li class="sidebar-sub-header"><a href="/python/senior/dynamic.html#_3-slots" class="sidebar-link">3. __slots__</a></li></ul></li><li><a href="/python/senior/metaclass.html" class="sidebar-link">元类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/metaclass.html#_1-类对象" class="sidebar-link">1. 类对象</a></li><li class="sidebar-sub-header"><a href="/python/senior/metaclass.html#_2-type-类" class="sidebar-link">2. type 类</a></li><li class="sidebar-sub-header"><a href="/python/senior/metaclass.html#_3-元类" class="sidebar-link">3. 元类</a></li></ul></li><li><a href="/python/senior/intern.html" class="sidebar-link">对象池与intern</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/intern.html#_1-字母小整数对象池" class="sidebar-link">1. 字母小整数对象池</a></li><li class="sidebar-sub-header"><a href="/python/senior/intern.html#_2-intern" class="sidebar-link">2. intern</a></li></ul></li><li><a href="/python/senior/gc.html" class="sidebar-link">垃圾回收（GC）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/gc.html#_1-引用计数" class="sidebar-link">1. 引用计数</a></li><li class="sidebar-sub-header"><a href="/python/senior/gc.html#_2-分代回收" class="sidebar-link">2. 分代回收</a></li><li class="sidebar-sub-header"><a href="/python/senior/gc.html#_3-gc-模块" class="sidebar-link">3. gc 模块</a></li></ul></li><li><a href="/python/senior/pdb.html" class="sidebar-link">pdb 调试工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/pdb.html#_1-使用方式" class="sidebar-link">1. 使用方式</a></li><li class="sidebar-sub-header"><a href="/python/senior/pdb.html#_2-pdb命令" class="sidebar-link">2. pdb命令</a></li></ul></li><li><a href="/python/senior/process.html" class="sidebar-link">多进程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/process.html#_1-fork" class="sidebar-link">1. fork</a></li><li class="sidebar-sub-header"><a href="/python/senior/process.html#_2-process" class="sidebar-link">2. Process</a></li><li class="sidebar-sub-header"><a href="/python/senior/process.html#_3-进程池" class="sidebar-link">3. 进程池</a></li><li class="sidebar-sub-header"><a href="/python/senior/process.html#_4-进程间通信-ipc" class="sidebar-link">4. 进程间通信(IPC)</a></li><li class="sidebar-sub-header"><a href="/python/senior/process.html#_5-cow" class="sidebar-link">5. COW</a></li></ul></li><li><a href="/python/senior/thread.html" class="sidebar-link">多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/thread.html#_1-多线程" class="sidebar-link">1. 多线程</a></li><li class="sidebar-sub-header"><a href="/python/senior/thread.html#_2-线程同步" class="sidebar-link">2. 线程同步</a></li><li class="sidebar-sub-header"><a href="/python/senior/thread.html#_3-数据共享" class="sidebar-link">3. 数据共享</a></li><li class="sidebar-sub-header"><a href="/python/senior/thread.html#_4-全局解释器锁-gil" class="sidebar-link">4. 全局解释器锁 (GIL)</a></li></ul></li><li><a href="/python/senior/coroutine.html" class="sidebar-link">协程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/coroutine.html#_1-协程" class="sidebar-link">1. 协程</a></li><li class="sidebar-sub-header"><a href="/python/senior/coroutine.html#_2-yield-协程" class="sidebar-link">2. yield 协程</a></li><li class="sidebar-sub-header"><a href="/python/senior/coroutine.html#_3-greenlet" class="sidebar-link">3. greenlet</a></li><li class="sidebar-sub-header"><a href="/python/senior/coroutine.html#_4-gevent" class="sidebar-link">4. gevent</a></li></ul></li><li><a href="/python/senior/network.html" class="sidebar-link">网络通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/network.html#_1-tcp-ip" class="sidebar-link">1. TCP/IP</a></li><li class="sidebar-sub-header"><a href="/python/senior/network.html#_2-划分子网" class="sidebar-link">2. 划分子网</a></li><li class="sidebar-sub-header"><a href="/python/senior/network.html#_3-局域网组网" class="sidebar-link">3. 局域网组网</a></li><li class="sidebar-sub-header"><a href="/python/senior/network.html#_4-跨网络通信" class="sidebar-link">4. 跨网络通信</a></li><li class="sidebar-sub-header"><a href="/python/senior/network.html#_5-dns" class="sidebar-link">5. DNS</a></li><li class="sidebar-sub-header"><a href="/python/senior/network.html#_6-常见网络攻击" class="sidebar-link">6. 常见网络攻击</a></li></ul></li><li><a href="/python/senior/udp.html" class="sidebar-link">UDP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/udp.html#_1-socket" class="sidebar-link">1. Socket</a></li><li class="sidebar-sub-header"><a href="/python/senior/udp.html#_2-udp-协议" class="sidebar-link">2. UDP 协议</a></li><li class="sidebar-sub-header"><a href="/python/senior/udp.html#_3-udp-socket" class="sidebar-link">3. UDP Socket</a></li><li class="sidebar-sub-header"><a href="/python/senior/udp.html#_4-tftp" class="sidebar-link">4. TFTP</a></li></ul></li><li><a href="/python/senior/tcp.html" aria-current="page" class="active sidebar-link">TCP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_1-三次握手" class="sidebar-link">1. 三次握手</a></li><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_2-四次挥手" class="sidebar-link">2. 四次挥手</a></li><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_3-2msl" class="sidebar-link">3. 2MSL</a></li><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_4-tcp-socket" class="sidebar-link">4. TCP Socket</a></li><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_5-长连接与短连接" class="sidebar-link">5. 长连接与短连接</a></li><li class="sidebar-sub-header"><a href="/python/senior/tcp.html#_6-多任务tcp服务器" class="sidebar-link">6. 多任务TCP服务器</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>算法与数据结构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/datastructure/algorithm.html" class="sidebar-link">算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/algorithm.html#_1-算法" class="sidebar-link">1. 算法</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/algorithm.html#_2-时间复杂度" class="sidebar-link">2. 时间复杂度</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/algorithm.html#_3-timeit" class="sidebar-link">3. timeit</a></li></ul></li><li><a href="/python/datastructure/sort.html" class="sidebar-link">排序算法与搜索算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_1-排序算法的稳定性" class="sidebar-link">1. 排序算法的稳定性</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_2-冒泡排序" class="sidebar-link">2. 冒泡排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_3-选择排序" class="sidebar-link">3. 选择排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_4-插入排序" class="sidebar-link">4. 插入排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_5-希尔排序" class="sidebar-link">5. 希尔排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_6-归并排序" class="sidebar-link">6. 归并排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_7-快速排序" class="sidebar-link">7. 快速排序</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_8-排序算法效率" class="sidebar-link">8. 排序算法效率</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sort.html#_9-搜索" class="sidebar-link">9. 搜索</a></li></ul></li><li><a href="/python/datastructure/datastructure.html" class="sidebar-link">数据结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/datastructure.html#_1-数据结构" class="sidebar-link">1. 数据结构</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/datastructure.html#_2-算法与数据结构" class="sidebar-link">2. 算法与数据结构</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/datastructure.html#_3-抽象数据类型-adt" class="sidebar-link">3. 抽象数据类型(ADT)</a></li></ul></li><li><a href="/python/datastructure/sequencelist.html" class="sidebar-link">顺序表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_1-线性表" class="sidebar-link">1. 线性表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_2-顺序表" class="sidebar-link">2. 顺序表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_3-存储方式" class="sidebar-link">3. 存储方式</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_4-存储结构" class="sidebar-link">4. 存储结构</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_5-常用操作" class="sidebar-link">5. 常用操作</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/sequencelist.html#_6-python-顺序表" class="sidebar-link">6. Python 顺序表</a></li></ul></li><li><a href="/python/datastructure/linkedlist.html" class="sidebar-link">链表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_1-链表" class="sidebar-link">1. 链表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_2-单向链表" class="sidebar-link">2. 单向链表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_3-单向循环链表" class="sidebar-link">3. 单向循环链表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_4-双向链表" class="sidebar-link">4. 双向链表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_5-顺序表与链表" class="sidebar-link">5. 顺序表与链表</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/linkedlist.html#_6-python-链表" class="sidebar-link">6. Python 链表</a></li></ul></li><li><a href="/python/datastructure/stackqueue.html" class="sidebar-link">栈 / 队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/stackqueue.html#_1-栈" class="sidebar-link">1. 栈</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/stackqueue.html#_2-队列" class="sidebar-link">2. 队列</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/stackqueue.html#_3-双端队列" class="sidebar-link">3. 双端队列</a></li></ul></li><li><a href="/python/datastructure/tree.html" class="sidebar-link">树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/datastructure/tree.html#_1-树" class="sidebar-link">1. 树</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/tree.html#_2-二叉树" class="sidebar-link">2. 二叉树</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/tree.html#_3-构建二叉树" class="sidebar-link">3. 构建二叉树</a></li><li class="sidebar-sub-header"><a href="/python/datastructure/tree.html#_4-遍历二叉树" class="sidebar-link">4. 遍历二叉树</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据操作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/database/mysql.html" class="sidebar-link">MySQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/database/mysql.html#_1-mysql" class="sidebar-link">1. MySQL</a></li><li class="sidebar-sub-header"><a href="/python/database/mysql.html#_2-pymysql" class="sidebar-link">2. PyMySQL</a></li><li class="sidebar-sub-header"><a href="/python/database/mysql.html#_3-sqlhelper" class="sidebar-link">3. SqlHelper</a></li></ul></li><li><a href="/python/database/redis.html" class="sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/database/redis.html#_1-redis-交互" class="sidebar-link">1. Redis 交互</a></li><li class="sidebar-sub-header"><a href="/python/database/redis.html#_2-redis-集群交互" class="sidebar-link">2. Redis 集群交互</a></li></ul></li><li><a href="/python/database/mongo.html" class="sidebar-link">MongoDB</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp"><a href="#tcp" class="header-anchor">#</a> TCP</h1> <p>传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议。TCP是为了在不可靠的互联网络上提供可靠的端到端字节流而专门设计的一个传输协议。</p> <h2 id="_1-三次握手"><a href="#_1-三次握手" class="header-anchor">#</a> 1. 三次握手</h2> <p>TCP使用三次握手协议建立连接。当主动方发出SYN连接请求后，等待对方回答SYN+ACK，并最终对对方的 SYN 执行 ACK 确认。</p> <p>TCP三次握手的过程如下：</p> <ul><li>(1) 客户端发送SYN（SEQ=x）报文给服务器端，进入SYN_SEND状态。</li> <li>(2) 服务器端收到SYN报文，回应一个SYN （SEQ=y）ACK（ACK=x+1）报文，进入SYN_RECV状态。</li> <li>(3) 客户端收到服务器端的SYN报文，回应一个ACK（ACK=y+1）报文，进入Established状态。</li></ul> <table><thead><tr><th style="text-align:left;">TCP 标志位</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">URG</td> <td style="text-align:left;">紧急</td></tr> <tr><td style="text-align:left;">ACK</td> <td style="text-align:left;">确认，使得确认号有效。</td></tr> <tr><td style="text-align:left;">PSH</td> <td style="text-align:left;">发送数据</td></tr> <tr><td style="text-align:left;">RST</td> <td style="text-align:left;">重置连接</td></tr> <tr><td style="text-align:left;">SYN</td> <td style="text-align:left;">同步(建立连接)</td></tr> <tr><td style="text-align:left;">FIN</td> <td style="text-align:left;">终止。发送方已经结束向对方发送数据。</td></tr></tbody></table> <p>TCP 标志位为6bit，从左至右分别为 <code>URG / ACK / PSH / RST / SYN / FIN</code>。如<code>0b000010</code>表示SYN，<code>0b010000</code>表示ACK。</p> <h2 id="_2-四次挥手"><a href="#_2-四次挥手" class="header-anchor">#</a> 2. 四次挥手</h2> <p><img src="https://i.loli.net/2020/02/25/vQGpumfiMOletc7.jpg" alt="TCP三次握手四次挥手与十种状态"></p> <p>由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。</p> <p>TCP四次挥手过程如下：</p> <ul><li>(1) TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。</li> <li>(2) 服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。</li> <li>(3) 服务器关闭客户端的连接，发送一个FIN给客户端。</li> <li>(4) 客户端发回ACK报文确认，并将确认序号设置为收到序号加1。</li></ul> <h2 id="_3-2msl"><a href="#_3-2msl" class="header-anchor">#</a> 3. 2MSL</h2> <p>MSL(Maximum Segment Lifetime) 是报文最大生存时间，即报文在网络上存在的最长时间，超过这个时间报文将被丢弃。MSL在不同操作系统中市场也不尽相同。</p> <table><thead><tr><th style="text-align:left;">Platform</th> <th style="text-align:left;">MSL</th></tr></thead> <tbody><tr><td style="text-align:left;">Windows</td> <td style="text-align:left;">120s</td></tr> <tr><td style="text-align:left;">Linux</td> <td style="text-align:left;">60s</td></tr> <tr><td style="text-align:left;">Unix</td> <td style="text-align:left;">30s</td></tr></tbody></table> <p>2MSL即两倍的MSL，TCP的TIME_WAIT状态也称为2MSL等待状态，当TCP的一端发起主动关闭，前第三次挥手完成后发送了第四次握手的ACK包后就进入了TIME_WAIT状态，如果出现服务端没有收到最后一次ACK确认的情况，服务端会在超时后重发第三次挥手的FIN包，经历来回数据包传输，所以客户端必须在此状态上停留两倍的MSL时间。客户端接到重发的FIN包后可以再发一个ACK应答包。</p> <p>在TIME_WAIT状态时两端的端口不能使用，要等到2MSL时间结束才可继续使用。实际应用中可以通过设置<code>SO_REUSEADDR</code>选项达到不必等待2MSL时间结束再使用此端口。</p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

tcp <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
SOL_SOCKET -&gt; 设置级别(Socket Option Level)为SOCKET
SO_REUSEADDR -&gt; 设置地址重用选项(Socket Option Reuse Address)
1 -&gt; 
&quot;&quot;&quot;</span>
tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># Socket地址重用  不必等待2MSL再使用当前地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_4-tcp-socket"><a href="#_4-tcp-socket" class="header-anchor">#</a> 4. TCP Socket</h2> <p>TCP是一种面向连接的单播协议，在发送数据前，通信双方必须在彼此间建立一条连接。由于需要比较复杂的过程建立连接，TCP需要耗费比UDP更多的资源，且速度略慢于UDP。</p> <p><img src="https://i.loli.net/2020/02/25/c8k9RmvDw45gFZs.png" alt="TCP通信模型"></p> <table><thead><tr><th style="text-align:left;">基本函数</th> <th style="text-align:left;">功能</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>listen()</code></td> <td style="text-align:left;">TCP服务端启动监听</td></tr> <tr><td style="text-align:left;"><code>accept()</code></td> <td style="text-align:left;">TCP服务器接受客户端连接并创建通信socket</td></tr> <tr><td style="text-align:left;"><code>connect(('hostaddr',port))</code></td> <td style="text-align:left;">TCP客户端连接服务端</td></tr> <tr><td style="text-align:left;"><code>recv(buffersize)</code></td> <td style="text-align:left;">接收数据。返回值为(data, address info)</td></tr> <tr><td style="text-align:left;"><code>send()</code></td> <td style="text-align:left;">发送数据</td></tr></tbody></table> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-py"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># 服务端</span>
tcp_server <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 创建tcp socket</span>
tcp_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">5678</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 服务端绑定端口</span>
tcp_server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 开启监听客户端连接。阻塞程序</span>
com_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token operator">=</span> tcp_server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 接受客户端连接并创建返回一个专门与之通信的socket</span>

msg <span class="token operator">=</span> com_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 通信socket接收客户端数据</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d - %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
com_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;test message from tcp server&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 通信socket发送数据到客户端</span>

com_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭通信socket，断开客户端连接。如果需要与之再次通信，需要客户端重新连接</span>
tcp_server<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭服务端socket，无法再监听客户端连接</span>


<span class="token comment"># 客户端</span>
tcp_client <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>  <span class="token comment"># 创建tcp socket</span>
tcp_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'192.168.0.223'</span><span class="token punctuation">,</span> <span class="token number">5678</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 连接tcp服务端</span>
tcp_client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;test message from tcp client&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 发送消息给服务端</span>
msg <span class="token operator">=</span> tcp_client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 接收服务端消息。阻塞程序</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tcp_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>当一个连接被建立或被终止时，交换的报文段只包含TCP头部，而没有数据。也就是说如果接收到的客户端数据长度为0，则意味着客户端断开连接。</p> <h2 id="_5-长连接与短连接"><a href="#_5-长连接与短连接" class="header-anchor">#</a> 5. 长连接与短连接</h2> <h3 id="_5-1-长短连接简介"><a href="#_5-1-长短连接简介" class="header-anchor">#</a> 5.1 长短连接简介</h3> <p>TCP在真正的读写操作之前，server与client之间会通过三次握手建立一个连接，当读写操作完成后，双方不再需要这个连接时会经历四次挥手释放这个连接，每次连接都会有一定的资源和时间消耗。</p> <p>在建立一次TCP连接之后完成一次数据传输工作后立即关闭连接，这种连接使用方式称为短链接，而连接建立后进行一次数据传输完成后，保持连接不关闭，直接进行后续数据操作直到完成后关闭连接，这种方式则称为长连接。</p> <p><img src="https://i.loli.net/2020/02/25/KhDAiuVyIjqLXgx.jpg" alt="短连接"></p> <p>短连接对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。但客户请求频繁，将在TCP的建立和关闭操作上浪费时间和带宽。多数情况下HTTP请求使用短链接的情况居多，一次请求完毕后连接即被释放，故而HTTP是无状态的。</p> <p><img src="https://i.loli.net/2020/02/25/qe6ryuaFHfO98d7.jpg" alt="长连接"></p> <p>长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。但可能存在大量闲置连接不关闭，甚至恶意连接，造成资源浪费。可以以客户端机器为颗粒度，限制每个客户端的最大长连接数。通常情况下数据库连接多使用长连接。</p> <h3 id="_5-2-服务器连接管理"><a href="#_5-2-服务器连接管理" class="header-anchor">#</a> 5.2 服务器连接管理</h3> <p>当TCP客户端与服务端完成第一次握手但尚未建立连接时，服务端会将此客户端加入到半连接队列，在三次握手后连接建立，服务端会将客户端从半连接队列已到已连接队列中。</p> <p>半连接队里与已连接队列中客户端的总和称为TCP服务器最大连接数，即同一时间TCP服务器可以接收的最多客户端连接数。这个数值就是<code>socket.listen(backlog)</code>中<code>backlog</code>设定的值。需要注意的是，<strong>Linux会忽略用户设置而由系统决定最大连接数</strong>。</p> <p>TCP服务器会为每个客户端连接创建一个专属Socket对象负责与此客户端进行通信。TCP服务端以连接为单位提供服务。所有客户端连接都被维护在连接队列当中，不同连接之间一般是并行执行，而单个连接内部则是串行执行。</p> <h3 id="_5-3-共享连接"><a href="#_5-3-共享连接" class="header-anchor">#</a> 5.3 共享连接</h3> <p>单客户端连接在服务端是串行执行，这也就意味着单个客户端内部，多任务之间共享一个连接对象时，即便并发请求也会被服务端串行依次处理。如果某此请求执行耗时任务，之后的请求就会等待，客户端在2MSL内没有收到ACK数据包就会执行重发，直到耗时任务行完毕后才会执行后续请求。因此，客户端程序中多任务共享单个连接与单任务执行并无分别。</p> <p>我们可以通过以下示例来验证刚才的结论。</p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey<span class="token punctuation">,</span> socket
<span class="token keyword">from</span> gevent <span class="token keyword">import</span> spawn<span class="token punctuation">,</span> sleep
<span class="token keyword">import</span> time

monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
sockets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[%s:%d] [recv] %s - %s &quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>ctime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;A456&quot;</span><span class="token punctuation">:</span>
                sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 模拟耗时任务</span>
            client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sockets<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d was disconnected&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>
            <span class="token keyword">break</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8086</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    sockets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tcp<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            client<span class="token punctuation">,</span> addr <span class="token operator">=</span> tcp<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sockets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d connected...&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>

            spawn<span class="token punctuation">(</span>process_request<span class="token punctuation">,</span> client<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> sock <span class="token keyword">in</span> sockets<span class="token punctuation">:</span>
            sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sockets<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>为了避免CPython中<a href="/python/senior/thread.html#_4-全局解释器锁-gil">GIL</a>伪多线程的影响，这里我们使用.Net Core来实现多任务TCP客户端。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">TcpClient</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> addr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8086</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> connA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            connA<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> connB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            connB<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">TestServer</span><span class="token punctuation">(</span>connA<span class="token punctuation">,</span> <span class="token string">&quot;A123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">TestServer</span><span class="token punctuation">(</span>connA<span class="token punctuation">,</span> <span class="token string">&quot;A456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//耗时任务</span>
            <span class="token function">TestServer</span><span class="token punctuation">(</span>connB<span class="token punctuation">,</span> <span class="token string">&quot;B456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">TestServer</span><span class="token punctuation">(</span>connA<span class="token punctuation">,</span> <span class="token string">&quot;A789&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TestServer</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> conn<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> msg<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                conn<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;[send] : </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;HH:mm:ss&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">msg</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> byteData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> length <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>byteData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;[recv] : </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;HH:mm:ss&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>byteData<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>IsBackground <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><img src="https://i.loli.net/2020/02/25/5QMEajBxP7HkLdo.jpg" alt="客户端共享TCP连接"></p> <blockquote><p>以上案例代码共享在<a href="https://github.com/colin-chang/LongConnectionExploration" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，有兴趣的读者可以自行测试。</p></blockquote> <h3 id="_5-4-数据库连接池"><a href="#_5-4-数据库连接池" class="header-anchor">#</a> 5.4 数据库连接池</h3> <p>数据库连接是一个很好案例,实际生产环境中，建立和释放数据库连接都需要耗费一定时间，因此数据连接属于比较珍贵的资源。如果每次客户端请求都新建立一个数据库连接，不仅耗费时间、资源更会对数据库造成压力，数据库能承受的并发连接访问是有限的。但是客户端内多任务共享一个连接又会相互影响，数据库连接池就是为了解决这个问题。</p> <p>为了避免客户端共享连接造成多任务间相互干扰，我们就需要为每个任务分配不同的数据库连接，而多数任务都是简单短促地执行完成，待任务完成后，我们不关闭数据库连接，而是将其放入一个共享队列中，待到其他任务需要申请数据库连接时，程序就可以直接到共享队列中快速获取一个连额使用而不需再经历三次握手重新建立新的连接，我们称这个共享队列为数据库连接池。</p> <p>不同的开发平台中对关系型数据库和非关系型数据库都有其各自的对数据库连接池实现和应用。以.Net平台为例，访问关系型数据库完成后调用<code>IDbConnection</code>对象的<code>Dispose()</code>时(多通过<code>using</code>关键字自动实现)会释放<code>IDbConnection</code>对象并将其占用的数据库连接归还到连接池中。在非关系型数据库中也有对数据库连接池的应用，如<a href="https://architecture.ccstudio.org/nosql/mongo.html#_8-2-mongo-%E8%BF%9E%E6%8E%A5%E6%B1%A0" target="_blank" rel="noopener noreferrer">MongoDB连接池<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,在<code>Mongo Driver</code>中提供的<code>MongoClient</code>对象本身就实现了一个线程安全的连接池。以下是来自其官方的阐述。</p> <blockquote><p>Note: The Mongo object instance actually represents a pool of connections to the database; you will only need one object of class Mongo even with multiple threads. See the concurrency doc page for more information.The Mongo class is designed to be thread safe and shared among threads. Typically you create only 1 instance for a given DB cluster and use it across your app.</p></blockquote> <h2 id="_6-多任务tcp服务器"><a href="#_6-多任务tcp服务器" class="header-anchor">#</a> 6. 多任务TCP服务器</h2> <p>默认情况下Socket通信采用的是同步阻塞IO模型。这种情况下服务器只能同时为一个客户端服务。如果要TCP服务器同时为多客户单同时服务，最简单可以使用多进程、多线程或协程实现。除此之外，我们还可以使用非阻塞IO模型和IO多路复用模型实现，而这些模型都是单线程的。</p> <p>我们可以参考以下代码测试多客户端同时连接TCP服务器。</p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time

g_socketList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    g_socketList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> g_socketList<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_6-1-协程"><a href="#_6-1-协程" class="header-anchor">#</a> 6.1 协程</h3> <p>与多线程用法类似，将会阻塞程序的耗时操作交由<a href="/python/senior/coroutine.html#_4-gevent">协程</a>执行，以实现多任务，同时为多客户端服务。</p> <div class="language-py line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-py"><code><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey<span class="token punctuation">,</span> socket

monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> gevent <span class="token keyword">import</span> spawn

sockets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 记录socket对象</span>


<span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ip<span class="token punctuation">,</span> port <span class="token operator">=</span> info
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d - %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sockets<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d was disconnected&quot;</span> <span class="token operator">%</span> info<span class="token punctuation">)</span>
            <span class="token keyword">break</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 必须使用gevent包装的socket模块</span>
    tcp<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    sockets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tcp<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            client<span class="token punctuation">,</span> addr <span class="token operator">=</span> tcp<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sockets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d connected...&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>

            spawn<span class="token punctuation">(</span>process_request<span class="token punctuation">,</span> client<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>  <span class="token comment"># 创建协程为客户端服务</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> sock <span class="token keyword">in</span> sockets<span class="token punctuation">:</span>
            sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sockets<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="_6-2-非阻塞io模型"><a href="#_6-2-非阻塞io模型" class="header-anchor">#</a> 6.2 非阻塞IO模型</h3> <p>除了传统的阻塞IO模型，我们还可以设置Socket为非阻塞模式。非阻塞模式下，服务端监听和客户端接收消息都不再阻塞程序。</p> <p>Python中使用非阻塞的socket,TCP服务端执行<code>accept()</code>时如果客户端没有<code>connect()</code>会抛出<code>OSError</code>，<code>recv()</code>则会抛出<code>BlockingIOError</code>需要开发者捕获异常。</p> <p>下面是一个用非阻塞IO模型实现的单线程仿多任务案例。</p> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-py"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 设置socket为非阻塞模式</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>  <span class="token comment"># 非阻塞模式执行accept()时如果客户端没有connect()会抛出OSError</span>
                client<span class="token punctuation">,</span> addr <span class="token operator">=</span> tcp<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
                client<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 设置通讯socket为非阻塞模式</span>
                clients<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d connected...&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>

            disconnected_clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 记录已断开的客户端</span>
            <span class="token keyword">for</span> client<span class="token punctuation">,</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">in</span> clients<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d - %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 接收到客户端数据长度为0，表示客户端关闭连接</span>
                        client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭为客户端服务的socket</span>
                        disconnected_clients<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d was disconnected&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>

            <span class="token keyword">for</span> client <span class="token keyword">in</span> disconnected_clients<span class="token punctuation">:</span>  <span class="token comment"># 删除已断开连接</span>
                clients<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            disconnected_clients<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        tcp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> sock <span class="token keyword">in</span> clients<span class="token punctuation">:</span>
            sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        clients<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>案例中使用了非阻塞的socket,<code>accept()</code>和<code>recv()</code>都不会阻塞程序，这样我们就可以通过单任务串行实现先检查是否有新客户端连接，然后再遍历已连接客户端接收数据，当客户端连接较少时，遍历已连接客户端接收消息耗时非常短，感觉上去基本与多任务效果无异。</p> <h3 id="_6-3-io多路复用模型"><a href="#_6-3-io多路复用模型" class="header-anchor">#</a> 6.3 IO多路复用模型</h3> <p>传统多进程或多线程中一个IO流就会开启一个进程(线程)处理，当IO流数量巨大时，会造成大量的资源占用。所以人们提出了I/O多路复用这个模型，一个线程，通过记录IO流的状态来同时管理多个IO，可以提高服务器的吞吐能力。</p> <p>在多路复用的模型中，比较常用的有<code>select</code>,<code>pool</code>和<code>epoll</code>模型。这些都是系统接口，由操作系统提供，各编程语言都是在此基础上做了更高级的封装。</p> <h4 id="_6-3-1-select-pool"><a href="#_6-3-1-select-pool" class="header-anchor">#</a> 6.3.1 select / pool</h4> <p>Python将<code>select</code>系统接口封装在<code>select</code>模块中。<code>select(rlist, wlist, xlist) -&gt; (rlist, wlist, xlist)</code>。用户将IO操作的socket添加到<code>select</code>的对应列表中。程序运行到<code>select()</code>时会被阻塞，此时系统内核会监视所有<code>select</code>负责的的<code>socket</code>，当监测的列发生变化，会立即解阻塞并返回当前检测列表，用户可以从新的列表中读取数据。<code>select()</code>监测的三个列表依次 可读列表/可写列表/异常列表。</p> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-py"><code><span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> select <span class="token keyword">import</span> select
<span class="token keyword">from</span> sys <span class="token keyword">import</span> stdin


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 设置socket为非阻塞模式</span>

    detected <span class="token operator">=</span> <span class="token punctuation">[</span>tcp<span class="token punctuation">,</span> stdin<span class="token punctuation">]</span>  <span class="token comment"># 初始化select可读监测列表。当tcp对象或stdin标准输入有状态变化时将会解除select阻塞</span>
    clients <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 记录客户端连接socket与其地址对应关系</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;type 'q' to exit&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        readable<span class="token punctuation">,</span> writeable<span class="token punctuation">,</span> exceptions <span class="token operator">=</span> select<span class="token punctuation">(</span>detected<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> sock <span class="token keyword">in</span> readable<span class="token punctuation">:</span>
            <span class="token keyword">if</span> sock <span class="token operator">==</span> stdin<span class="token punctuation">:</span>  <span class="token comment"># 1. 用户输入-解除select阻塞</span>
                cmd <span class="token operator">=</span> stdin<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> cmd <span class="token operator">!=</span> <span class="token string">&quot;q\n&quot;</span><span class="token punctuation">:</span>  <span class="token comment"># 输入q关闭所有socket并退出程序</span>
                    <span class="token keyword">continue</span>

                <span class="token keyword">for</span> so <span class="token keyword">in</span> detected<span class="token punctuation">:</span>
                    so<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                detected<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;exit...&quot;</span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> sock <span class="token operator">==</span> tcp<span class="token punctuation">:</span>  <span class="token comment"># 2. 客户端连接-解除select阻塞</span>
                client<span class="token punctuation">,</span> addr <span class="token operator">=</span> tcp<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
                client<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                detected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>client<span class="token punctuation">)</span>  <span class="token comment"># 将客户端连接加入监测列表</span>
                clients<span class="token punctuation">[</span>client<span class="token punctuation">]</span> <span class="token operator">=</span> addr
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d connected...&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 3. 客户端消息-解除select阻塞</span>
                data <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                ip<span class="token punctuation">,</span> port <span class="token operator">=</span> clients<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sock<span class="token punctuation">)</span>
                <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d - %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 接收到客户端数据长度为0，表示客户端关闭连接</span>
                    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭为客户端服务的socket</span>
                    detected<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>sock<span class="token punctuation">)</span>
                    <span class="token keyword">del</span> clients<span class="token punctuation">[</span>sock<span class="token punctuation">]</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d was disconnected&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>使用内核<code>select</code>可以高效地监测socket对象的状态变化并提取有变动的socket队形，如此可以有的放矢的操作有效socket，而不必一直手动遍历轮训所有客户端socket接收数据。<code>select</code>目前支持所有常见平台。</p> <p>select的一个缺点在于单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过修改宏定义甚至重新编译内核的方式提升这一限制。每次调用select，都需要把fd集合从用户态拷贝到内核态，这个开销在fd很多时会很大，同时每次调用select都需要在内核遍历传递进来的所有fd，这个开销在fd很多时也会很大。</p> <p><code>poll</code>与<code>select</code>没有本质上的差别，仅仅是没有了最大文件描述符数量的限制，使用较少不做详述。</p> <h4 id="_6-3-2-epool"><a href="#_6-3-2-epool" class="header-anchor">#</a> 6.3.2 epool</h4> <p>epoll(<strong>仅支持Linux</strong>)具备了<code>select</code>和<code>poll</code>的一切优点，公认为性能最好的多路IO就绪通知方法。
<code>epoll</code>没有最大并发连接的限制，能打开的FD(指的是文件描述符，通俗的理解就是套接字对应的数字编号)的上限远大于1024。</p> <p><code>epoll</code>不用轮询socket的方式，转而采用事件通知机制。有效的活跃连接发生变化时会主动调用<code>callback</code>函数，而不需要轮询。<code>epoll</code>最大的优点就在于它只管“活跃”的连接，而跟连接总数无关，它不会随着FD数目的增加效率下降，因此在实际的网络环境中，<code>epoll</code>的效率就会远远高于<code>select</code>和<code>poll</code>。</p> <div class="custom-block tip"><p class="custom-block-title">水平触发与边缘触发(EPOLLET)</p> <p><code>epoll</code>同时支持水平触发与边缘触发(EPOLLET),默认水平触发。理论上边缘触发的性能略高一些。</p> <ul><li>水平触发：将就绪的文件描述符告诉进程后，如果进程没有对其进行IO操作，那么下次调用epoll时将再次报告这些文件描述符，这种方式称为水平触发</li> <li>边缘触发：只告诉进程哪些文件描述符刚刚变为就绪状态，它只说一遍，如果我们没有采取行动，那么它将不会再次告知，这种方式称为边缘触发</li></ul></div> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-py"><code><span class="token comment"># 以下代码仅支持Linux</span>

<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> select <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> sys <span class="token keyword">import</span> stdin


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tcp <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    tcp<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>

    epl <span class="token operator">=</span> epoll<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建一个epoll对象</span>
    epl<span class="token punctuation">.</span>register<span class="token punctuation">(</span>tcp<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">)</span>  <span class="token comment"># tcp对象注册epoll&quot;可读&quot;事件</span>
    epl<span class="token punctuation">.</span>register<span class="token punctuation">(</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">)</span>  <span class="token comment"># 注册标准键盘输入</span>

    clients <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 记录客户端连接socket与其地址对应关系</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;type 'q' to exit&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        pol <span class="token operator">=</span> epl<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># epoll 阻塞进行 fd 扫描。注册的socket对象状态有变动会自动进行事件通知并解阻塞</span>
        <span class="token keyword">for</span> fd<span class="token punctuation">,</span> event <span class="token keyword">in</span> pol<span class="token punctuation">:</span>
            <span class="token keyword">if</span> fd <span class="token operator">==</span> stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 1. 键盘输入</span>
                cmd <span class="token operator">=</span> stdin<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> cmd <span class="token operator">!=</span> <span class="token string">&quot;q\n&quot;</span><span class="token punctuation">:</span>  <span class="token comment"># 输入q关闭所有socket并退出程序</span>
                    <span class="token keyword">continue</span>

                <span class="token keyword">for</span> fn<span class="token punctuation">,</span> <span class="token punctuation">(</span>client<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token keyword">in</span> clients<span class="token punctuation">:</span>  <span class="token comment"># 注销所有epoll事件监听并关闭所有socket</span>
                    epl<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
                    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                clients<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;exit...&quot;</span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> fd <span class="token operator">==</span> tcp<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 2. 有客户端连接</span>
                client<span class="token punctuation">,</span> addr <span class="token operator">=</span> tcp<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
                clients<span class="token punctuation">[</span>client<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>client<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
                epl<span class="token punctuation">.</span>register<span class="token punctuation">(</span>client<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">)</span>  <span class="token comment"># 客户端连接socket注册epoll可读事件</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d connected...&quot;</span> <span class="token operator">%</span> addr<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> event <span class="token operator">==</span> EPOLLIN<span class="token punctuation">:</span>  <span class="token comment"># 3. 有客户端消息</span>
                client<span class="token punctuation">,</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token operator">=</span> clients<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d - %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 接收到客户端数据长度为0，表示客户端关闭连接</span>
                    epl<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>  <span class="token comment"># 注销epoll事件监听</span>
                    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭为客户端服务的socket</span>
                    <span class="token keyword">del</span> clients<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d was disconnected&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">多任务TCP服务器的各种实现方式性能比较</p> <p>网络通信属于IO密集型操作，因此多线程和协程比多进程更有优势。而协程比多线程更为高效。</p> <p>自定义实现的非阻塞IO模型需要手动遍历客户端连接变化，没有内核级的<code>select</code>方式的IO多路复用高效，而采用事件通知机制的<code>epoll</code>又比轮询方式的<code>select</code>效率更高。</p> <p>协程实现方式中协程的调度函数会不断的判断协程中耗时操作执行情况，以在合适时间切换协程，相当于轮询操作，依然没有<code>epoll</code>的主动事件通知高效,遗憾的是<code>epoll</code>仅支持Linux平台。</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/18/2020, 2:30:13 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/senior/udp.html" class="prev">
        UDP
      </a></span> <span class="next"><a href="/python/datastructure/algorithm.html">
        算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/python/assets/js/app.e1ee403d.js" defer></script><script src="/python/assets/js/2.968a03f5.js" defer></script><script src="/python/assets/js/46.e64c4e17.js" defer></script>
  </body>
</html>
